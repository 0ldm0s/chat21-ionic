<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>@chat21/chat21-ionic documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">@chat21/chat21-ionic documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">







<ol class="breadcrumb">
  <li>Injectables</li>
  <li>ChatConversationHandler</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/providers/chat-conversation-handler.ts</code>
        </p>




            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#attributes">attributes</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#CLIENT_BROWSER">CLIENT_BROWSER</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#conversationWith">conversationWith</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#events">events</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#listMembersInfo">listMembersInfo</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#listSubsriptions">listSubsriptions</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#loggedUser">loggedUser</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#messages">messages</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#messagesRef">messagesRef</a>
                            </li>
                            <li>
                                <a href="#obsAdded">obsAdded</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#recipientFullname">recipientFullname</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#recipientId">recipientId</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#senderId">senderId</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#tenant">tenant</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#translate">translate</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#urlNodeFirebase">urlNodeFirebase</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#connect">connect</a>
                            </li>
                            <li>
                                <a href="#dispose">dispose</a>
                            </li>
                            <li>
                                <a href="#initWithRecipient">initWithRecipient</a>
                            </li>
                            <li>
                                <a href="#isSender">isSender</a>
                            </li>
                            <li>
                                <a href="#sendMessage">sendMessage</a>
                            </li>
                            <li>
                                <a href="#setAttributes">setAttributes</a>
                            </li>
                            <li>
                                <a href="#setStatusMessage">setStatusMessage</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#translateInfoSupportMessages">translateInfoSupportMessages</a>
                            </li>
                            <li>
                                <a href="#unsubscribe">unsubscribe</a>
                            </li>
                            <li>
                                <a href="#updateMetadataMessage">updateMetadataMessage</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(events: Events, translate: TranslateService)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="42" class="link-to-prism">src/providers/chat-conversation-handler.ts:42</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>events</td>
                                                  
                                                        <td>
                                                                    <code>Events</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>translate</td>
                                                  
                                                        <td>
                                                                    <code>TranslateService</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="connect"></a>
                    <span class="name">
                        <b>
                            connect
                        </b>
                        <a href="#connect"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>connect()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="96"
                            class="link-to-prism">src/providers/chat-conversation-handler.ts:96</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>mi connetto al nodo messages
recupero gli ultimi 100 messaggi
creo la reference
mi sottoscrivo a change, removed, added</p>
</div>

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="dispose"></a>
                    <span class="name">
                        <b>
                            dispose
                        </b>
                        <a href="#dispose"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>dispose()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="400"
                            class="link-to-prism">src/providers/chat-conversation-handler.ts:400</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>dispose reference della conversazione</p>
</div>

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="initWithRecipient"></a>
                    <span class="name">
                        <b>
                            initWithRecipient
                        </b>
                        <a href="#initWithRecipient"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>initWithRecipient(recipientId, recipientFullName, loggedUser, tenant)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="63"
                            class="link-to-prism">src/providers/chat-conversation-handler.ts:63</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>inizializzo conversation handler</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>recipientId</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>recipientFullName</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>loggedUser</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>tenant</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="isSender"></a>
                    <span class="name">
                        <b>
                            isSender
                        </b>
                        <a href="#isSender"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>isSender(message, currentUser)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="297"
                            class="link-to-prism">src/providers/chat-conversation-handler.ts:297</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>controllo se il messaggio è stato inviato da loggerUser
richiamato dalla pagina elenco messaggi della conversazione</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>message</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>currentUser</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="sendMessage"></a>
                    <span class="name">
                        <b>
                            sendMessage
                        </b>
                        <a href="#sendMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>sendMessage(msg, type, metadata, conversationWith, conversationWithDetailFullname, channel_type)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="321"
                            class="link-to-prism">src/providers/chat-conversation-handler.ts:321</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>bonifico url in testo messaggio
recupero time attuale
recupero lingua app
recupero sender_fullname e recipient_fullname
aggiungo messaggio alla reference</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>msg</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>type</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>metadata</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>conversationWith</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>conversationWithDetailFullname</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>channel_type</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="setAttributes"></a>
                    <span class="name">
                        <b>
                            setAttributes
                        </b>
                        <a href="#setAttributes"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>setAttributes()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="75"
                            class="link-to-prism">src/providers/chat-conversation-handler.ts:75</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="setStatusMessage"></a>
                    <span class="name">
                        <b>
                            setStatusMessage
                        </b>
                        <a href="#setStatusMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>setStatusMessage(item, conversationWith)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="280"
                            class="link-to-prism">src/providers/chat-conversation-handler.ts:280</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>arriorno lo stato del messaggio
questo stato indica che è stato consegnato al client e NON che è stato letto
se il messaggio NON è stato inviato da loggedUser AGGIORNO stato a 200</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>item</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>conversationWith</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="translateInfoSupportMessages"></a>
                    <span class="name">
                        <b>
                            <span class="modifier">Private</span>
                            translateInfoSupportMessages
                        </b>
                        <a href="#translateInfoSupportMessages"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>translateInfoSupportMessages(message: <a href="../classes/MessageModel.html">MessageModel</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="212"
                            class="link-to-prism">src/providers/chat-conversation-handler.ts:212</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>message</td>
                                    <td>
                                                <code><a href="../classes/MessageModel.html" target="_self" >MessageModel</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="unsubscribe"></a>
                    <span class="name">
                        <b>
                            unsubscribe
                        </b>
                        <a href="#unsubscribe"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>unsubscribe(key)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="405"
                            class="link-to-prism">src/providers/chat-conversation-handler.ts:405</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>key</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateMetadataMessage"></a>
                    <span class="name">
                        <b>
                            updateMetadataMessage
                        </b>
                        <a href="#updateMetadataMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>updateMetadataMessage(uid, metadata)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="378"
                            class="link-to-prism">src/providers/chat-conversation-handler.ts:378</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>uid</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>metadata</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="attributes"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            attributes</b>
                            <a href="#attributes"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="35" class="link-to-prism">src/providers/chat-conversation-handler.ts:35</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="CLIENT_BROWSER"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            CLIENT_BROWSER</b>
                            <a href="#CLIENT_BROWSER"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="36" class="link-to-prism">src/providers/chat-conversation-handler.ts:36</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="conversationWith"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            conversationWith</b>
                            <a href="#conversationWith"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="31" class="link-to-prism">src/providers/chat-conversation-handler.ts:31</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="events"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            events</b>
                            <a href="#events"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code>Events</code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="45" class="link-to-prism">src/providers/chat-conversation-handler.ts:45</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="listMembersInfo"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            listMembersInfo</b>
                            <a href="#listMembersInfo"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code>any[]</code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="42" class="link-to-prism">src/providers/chat-conversation-handler.ts:42</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="listSubsriptions"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            listSubsriptions</b>
                            <a href="#listSubsriptions"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code>any[]</code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="34" class="link-to-prism">src/providers/chat-conversation-handler.ts:34</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="loggedUser"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Private</span>
                            loggedUser</b>
                            <a href="#loggedUser"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="../classes/UserModel.html" target="_self" >UserModel</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="29" class="link-to-prism">src/providers/chat-conversation-handler.ts:29</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="messages"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            messages</b>
                            <a href="#messages"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code>any[]</code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="32" class="link-to-prism">src/providers/chat-conversation-handler.ts:32</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="messagesRef"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            messagesRef</b>
                            <a href="#messagesRef"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code>firebase.database.Query</code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="33" class="link-to-prism">src/providers/chat-conversation-handler.ts:33</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="obsAdded"></a>
                        <span class="name">
                            <b>
                            obsAdded</b>
                            <a href="#obsAdded"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="../classes/MessageModel.html" target="_self" >BehaviorSubject&lt;MessageModel&gt;</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="39" class="link-to-prism">src/providers/chat-conversation-handler.ts:39</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="recipientFullname"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Private</span>
                            recipientFullname</b>
                            <a href="#recipientFullname"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="27" class="link-to-prism">src/providers/chat-conversation-handler.ts:27</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="recipientId"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Private</span>
                            recipientId</b>
                            <a href="#recipientId"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="26" class="link-to-prism">src/providers/chat-conversation-handler.ts:26</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="senderId"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Private</span>
                            senderId</b>
                            <a href="#senderId"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="30" class="link-to-prism">src/providers/chat-conversation-handler.ts:30</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="tenant"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Private</span>
                            tenant</b>
                            <a href="#tenant"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="28" class="link-to-prism">src/providers/chat-conversation-handler.ts:28</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="translate"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            translate</b>
                            <a href="#translate"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code>TranslateService</code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="46" class="link-to-prism">src/providers/chat-conversation-handler.ts:46</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="urlNodeFirebase"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Private</span>
                            urlNodeFirebase</b>
                            <a href="#urlNodeFirebase"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="25" class="link-to-prism">src/providers/chat-conversation-handler.ts:25</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@angular/core&#x27;;
import &#x27;rxjs/add/operator/map&#x27;;
import { Events } from &#x27;ionic-angular&#x27;;
// firebase
import * as firebase from &#x27;firebase/app&#x27;;
// models
import { MessageModel } from &#x27;../models/message&#x27;;
import { UserModel } from &#x27;../models/user&#x27;;
// services
//import { ChatManager } from &#x27;./chat-manager/chat-manager&#x27;;
// utils
import { TYPE_MSG_IMAGE, MSG_STATUS_RECEIVED, CLIENT_BROWSER } from &#x27;../utils/constants&#x27;;
import { htmlEntities, replaceBr, compareValues, urlify, searchIndexInArrayForUid, setHeaderDate, conversationMessagesRef } from &#x27;../utils/utils&#x27;;
import { TranslateService } from &#x27;@ngx-translate/core&#x27;;
import { BehaviorSubject } from &#x27;../../node_modules/rxjs/BehaviorSubject&#x27;;


//import { TranslateModule } from &#x27;@ngx-translate/core&#x27;;
//import { TranslateService } from &#x27;@ngx-translate/core&#x27;;
//import { CustomTranslateService } from &#x27;./translate-service&#x27;;


@Injectable()
export class ChatConversationHandler {
  private urlNodeFirebase: string;
  private recipientId: string;
  private recipientFullname: string;
  private tenant: string;
  private loggedUser: UserModel;
  private senderId: string;
  public conversationWith: string;
  public messages: any[];
  public messagesRef: firebase.database.Query;
  public listSubsriptions: any[];
  public attributes: any;
  public CLIENT_BROWSER: string;
  //public events: Events;

  obsAdded: BehaviorSubject&lt;MessageModel&gt;;


  public listMembersInfo: any[];

  constructor(
    public events: Events,
    public translate: TranslateService
  ) {
    // console.log(&quot;CONSTRUCTOR ChatConversationHandlerProvider&quot;);
    console.log(&quot;CONSTRUCTOR ChatConversationHandlerProvider&quot;, translate);
    //this.tenant &#x3D; this.chatManager.getTenant();
    //this.loggedUser &#x3D; this.chatManager.getLoggedUser();
    //this.events &#x3D; new Events();
    this.listSubsriptions &#x3D; [];
    this.CLIENT_BROWSER &#x3D; navigator.userAgent;
    this.obsAdded &#x3D; new BehaviorSubject&lt;MessageModel&gt;(null);
  }

  /**
   * inizializzo conversation handler
   * @param recipientId 
   * @param recipientFullName 
   */
  initWithRecipient(recipientId,recipientFullName, loggedUser, tenant) {
    this.loggedUser &#x3D; loggedUser;
    this.tenant &#x3D; tenant;
    this.recipientId &#x3D; recipientId;
    this.recipientFullname &#x3D; recipientFullName;
    this.senderId &#x3D; this.loggedUser.uid;
    this.conversationWith &#x3D; recipientId;
    this.messages &#x3D; [];
    this.attributes &#x3D; this.setAttributes();
    
  }

  setAttributes(): any {
    let attributes: any &#x3D; JSON.parse(sessionStorage.getItem(&#x27;attributes&#x27;));
    if (!attributes || attributes &#x3D;&#x3D;&#x3D; &#x27;undefined&#x27;) {
        attributes &#x3D; {
            client: this.CLIENT_BROWSER,
            sourcePage: location.href,
            userEmail: this.loggedUser.email,
            userFullname: this.loggedUser.fullname
        };
        console.log(&#x27;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; setAttributes: &#x27;, JSON.stringify(attributes));
        sessionStorage.setItem(&#x27;attributes&#x27;, JSON.stringify(attributes));
    }
    return attributes;
  }

  /**
   * mi connetto al nodo messages
   * recupero gli ultimi 100 messaggi
   * creo la reference
   * mi sottoscrivo a change, removed, added
   */
  connect() {
    var lastDate: string &#x3D; &quot;&quot;;
    const that &#x3D; this;
    this.urlNodeFirebase &#x3D; conversationMessagesRef(this.tenant, this.loggedUser.uid);
    this.urlNodeFirebase &#x3D; this.urlNodeFirebase+this.conversationWith;
    console.log(&quot;urlNodeFirebase *****&quot;, this.urlNodeFirebase);
    const firebaseMessages &#x3D; firebase.database().ref(this.urlNodeFirebase);
    this.messagesRef &#x3D; firebaseMessages.orderByChild(&#x27;timestamp&#x27;).limitToLast(100);
    console.log(&quot;this.translate *****&quot;, this.translate);

    //// AGGIUNTA MESSAGGIO ////
    this.messagesRef.on(&quot;child_added&quot;, function (childSnapshot) {
      const itemMsg &#x3D; childSnapshot.val();
      // imposto il giorno del messaggio per visualizzare o nascondere l&#x27;header data
      console.log(&quot;that.translate *****&quot;, that.translate);
      let calcolaData &#x3D; setHeaderDate(that.translate, itemMsg[&#x27;timestamp&#x27;], lastDate);
      if (calcolaData !&#x3D; null) {
        lastDate &#x3D; calcolaData;
      }
      // controllo fatto per i gruppi da rifattorizzare
      (!itemMsg.sender_fullname || itemMsg.sender_fullname &#x3D;&#x3D; &#x27;undefined&#x27;) ? itemMsg.sender_fullname &#x3D; itemMsg.sender : itemMsg.sender_fullname;
      // bonifico messaggio da url
      //let messageText &#x3D; replaceBr(itemMsg[&#x27;text&#x27;]);
      let messageText &#x3D; itemMsg[&#x27;text&#x27;];
      if (itemMsg[&#x27;type&#x27;] &#x3D;&#x3D; &#x27;text&#x27;) {
        //messageText &#x3D; urlify(itemMsg[&#x27;text&#x27;]);
        messageText &#x3D; htmlEntities(itemMsg[&#x27;text&#x27;]);
      }

      if (itemMsg[&#x27;metadata&#x27;]) {
        const index &#x3D; searchIndexInArrayForUid(that.messages, itemMsg[&#x27;metadata&#x27;].uid);
        if (index &gt; -1) {
          that.messages.splice(index, 1);
        }
      }

      // creo oggetto messaggio e lo aggiungo all&#x27;array dei messaggi
      
      const msg &#x3D; new MessageModel(childSnapshot.key, itemMsg[&#x27;language&#x27;], itemMsg[&#x27;recipient&#x27;], itemMsg[&#x27;recipient_fullname&#x27;], itemMsg[&#x27;sender&#x27;], itemMsg[&#x27;sender_fullname&#x27;], itemMsg[&#x27;status&#x27;], itemMsg[&#x27;metadata&#x27;], messageText, itemMsg[&#x27;timestamp&#x27;], calcolaData, itemMsg[&#x27;type&#x27;], itemMsg[&#x27;attributes&#x27;], itemMsg[&#x27;channel_type&#x27;]);
      //console.log(&quot;child_added *****&quot;, itemMsg[&#x27;timestamp&#x27;], that.messages, msg);
      
      if (msg.attributes &amp;&amp; msg.attributes.subtype &amp;&amp; (msg.attributes.subtype &#x3D;&#x3D;&#x3D; &#x27;info&#x27; || msg.attributes.subtype &#x3D;&#x3D;&#x3D; &#x27;info/support&#x27;)) {
        that.translateInfoSupportMessages(msg);
      }

      that.messages.push(msg);
      that.messages.sort(compareValues(&#x27;timestamp&#x27;, &#x27;asc&#x27;));

      // aggiorno stato messaggio
      // questo stato indica che è stato consegnato al client e NON che è stato letto
      that.setStatusMessage(childSnapshot, that.conversationWith);

      console.log(&quot;msg.sender ***** &quot; + msg.sender + &quot; that.loggedUser.uid:::&quot; + that.loggedUser.uid);
      if (msg.sender &#x3D;&#x3D;&#x3D; that.loggedUser.uid) {
        that.events.publish(&#x27;doScroll&#x27;);
      }

      that.obsAdded.next(msg);
      // pubblico messaggio - sottoscritto in dettaglio conversazione
      //console.log(&quot;publish:: &quot;, &#x27;listMessages:added-&#x27;+that.conversationWith, that.events);
      //that.events.publish(&#x27;listMessages:added-&#x27;+that.conversationWith, that.conversationWith, msg);
    })

    //// SUBSRIBE CHANGE ////
    this.messagesRef.on(&quot;child_changed&quot;, function(childSnapshot) {
      const itemMsg &#x3D; childSnapshot.val();
      // imposto il giorno del messaggio per visualizzare o nascondere l&#x27;header data
      const calcolaData &#x3D; setHeaderDate(that.translate, itemMsg[&#x27;timestamp&#x27;], lastDate);
      if (calcolaData !&#x3D; null) {
        lastDate &#x3D; calcolaData;
      }
      // controllo fatto per i gruppi da rifattorizzare
      (!itemMsg.sender_fullname || itemMsg.sender_fullname &#x3D;&#x3D; &#x27;undefined&#x27;) ? itemMsg.sender_fullname &#x3D; itemMsg.sender : itemMsg.sender_fullname;
      // bonifico messaggio da url
      //let messageText &#x3D; replaceBr(itemMsg[&#x27;text&#x27;]);
      let messageText &#x3D; itemMsg[&#x27;text&#x27;];
      if (itemMsg[&#x27;type&#x27;] &#x3D;&#x3D; &#x27;text&#x27;) {
        //messageText &#x3D; urlify(itemMsg[&#x27;text&#x27;]);
        messageText &#x3D; htmlEntities(itemMsg[&#x27;text&#x27;]);
      }
      // creo oggetto messaggio e lo aggiungo all&#x27;array dei messaggi
      const msg &#x3D; new MessageModel(childSnapshot.key, itemMsg[&#x27;language&#x27;], itemMsg[&#x27;recipient&#x27;], itemMsg[&#x27;recipient_fullname&#x27;], itemMsg[&#x27;sender&#x27;], itemMsg[&#x27;sender_fullname&#x27;], itemMsg[&#x27;status&#x27;], itemMsg[&#x27;metadata&#x27;], messageText, itemMsg[&#x27;timestamp&#x27;], calcolaData, itemMsg[&#x27;type&#x27;], itemMsg[&#x27;attributes&#x27;], itemMsg[&#x27;channel_type&#x27;]);
      const index &#x3D; searchIndexInArrayForUid(that.messages, childSnapshot.key);

      if (msg.attributes &amp;&amp; msg.attributes.subtype &amp;&amp; (msg.attributes.subtype &#x3D;&#x3D;&#x3D; &#x27;info&#x27; || msg.attributes.subtype &#x3D;&#x3D;&#x3D; &#x27;info/support&#x27;)) {
        that.translateInfoSupportMessages(msg);
      }
      
      that.messages.splice(index, 1, msg);
      // aggiorno stato messaggio
      // questo stato indica che è stato consegnato al client e NON che è stato letto
      that.setStatusMessage(childSnapshot, that.conversationWith);

      if (that.isSender(msg, that.loggedUser)) {
        that.events.publish(&#x27;doScroll&#x27;);
      }
      // pubblico messaggio - sottoscritto in dettaglio conversazione
      //that.events.publish(&#x27;listMessages:changed-&#x27;+that.conversationWith, that.conversationWith, that.messages);
      //that.events.publish(&#x27;listMessages:changed-&#x27;+that.conversationWith, that.conversationWith, msg);
    });

    this.messagesRef.on(&quot;child_removed&quot;, function(childSnapshot) {
      // al momento non previsto!!!
      const index &#x3D; searchIndexInArrayForUid(that.messages, childSnapshot.key);
      // controllo superfluo sarà sempre maggiore
      if (index &gt; -1) {
        that.messages.splice(index, 1);
        //this.events.publish(&#x27;conversations:update-&#x27;+that.conversationWith, that.messages);
      }

      // if(!this.isSender(msg)){
      //   that.events.publish(&#x27;doScroll&#x27;);
      // }
    });
  } 
   
  private translateInfoSupportMessages(message: MessageModel) {
    // console.log(&quot;ChatConversationHandler::translateInfoSupportMessages::message:&quot;, message);

    // check if the message has attributes, attributes.subtype and these values
    if (message.attributes &amp;&amp; message.attributes.subtype &amp;&amp; (message.attributes.subtype &#x3D;&#x3D;&#x3D; &#x27;info&#x27; || message.attributes.subtype &#x3D;&#x3D;&#x3D; &#x27;info/support&#x27;)) {
      
      // check if the message attributes has parameters and it is of the &quot;MEMBER_JOINED_GROUP&quot; type
      // [BEGIN MEMBER_JOINED_GROUP]
      if ((message.attributes.messagelabel &amp;&amp; message.attributes.messagelabel.parameters &amp;&amp; message.attributes.messagelabel.key &#x3D;&#x3D;&#x3D; &#x27;MEMBER_JOINED_GROUP&#x27;)) {
        
        var subject;
        var verb;
        var complement;
        
        if (message.attributes.messagelabel.parameters.member_id &#x3D;&#x3D;&#x3D; this.loggedUser.uid) {
          // logged user has been added to the group
          subject &#x3D; this.translate.get(&#x27;INFO_SUPPORT_USER_ADDED_SUBJECT&#x27;)[&#x27;value&#x27;];
          verb &#x3D; this.translate.get(&#x27;INFO_SUPPORT_USER_ADDED_YOU_VERB&#x27;)[&#x27;value&#x27;];
          complement &#x3D; this.translate.get(&#x27;INFO_SUPPORT_USER_ADDED_COMPLEMENT&#x27;)[&#x27;value&#x27;];
        } else {
          if (message.attributes.messagelabel.parameters.fullname) {
            // other user has been added to the group (and he has a fullname)
            subject &#x3D; message.attributes.messagelabel.parameters.fullname;
            verb &#x3D; this.translate.get(&#x27;INFO_SUPPORT_USER_ADDED_VERB&#x27;)[&#x27;value&#x27;];
            complement &#x3D; this.translate.get(&#x27;INFO_SUPPORT_USER_ADDED_COMPLEMENT&#x27;)[&#x27;value&#x27;];
          } else {
            // other user has been added to the group (and he has not a fullname, so use hes useruid)
            subject &#x3D; message.attributes.messagelabel.parameters.member_id;
            verb &#x3D; this.translate.get(&#x27;INFO_SUPPORT_USER_ADDED_VERB&#x27;)[&#x27;value&#x27;];
            complement &#x3D; this.translate.get(&#x27;INFO_SUPPORT_USER_ADDED_COMPLEMENT&#x27;)[&#x27;value&#x27;];
          }
        }

        // perform translation
        this.translate.get(&#x27;INFO_SUPPORT_USER_ADDED_MESSAGE&#x27;, {
          &#x27;subject&#x27;: subject,
          &#x27;verb&#x27;: verb,
          &#x27;complement&#x27;: complement
        }).subscribe((res: string) &#x3D;&gt; {
          message.text &#x3D; res;
        });

      } // [END MEMBER_JOINED_GROUP]

      // [END CHAT_REOPENED]
      else if ((message.attributes.messagelabel &amp;&amp; message.attributes.messagelabel.key &#x3D;&#x3D;&#x3D; &#x27;CHAT_REOPENED&#x27;)) {
        message.text &#x3D; this.translate.get(&#x27;INFO_SUPPORT_CHAT_REOPENED&#x27;)[&#x27;value&#x27;];
      }
      // [END CHAT_REOPENED]

      // [END CHAT_CLOSED]
      else if ((message.attributes.messagelabel &amp;&amp; message.attributes.messagelabel.key &#x3D;&#x3D;&#x3D; &#x27;CHAT_CLOSED&#x27;)) {
        message.text &#x3D; this.translate.get(&#x27;INFO_SUPPORT_CHAT_CLOSED&#x27;)[&#x27;value&#x27;];
      }
      // [END CHAT_CLOSED]
    }
   

  }


  /**
   * arriorno lo stato del messaggio
   * questo stato indica che è stato consegnato al client e NON che è stato letto
   * se il messaggio NON è stato inviato da loggedUser AGGIORNO stato a 200
   * @param item 
   * @param conversationWith 
   */
  setStatusMessage(item,conversationWith){
    if(item.val()[&#x27;status&#x27;] &lt; MSG_STATUS_RECEIVED){
      //const tenant &#x3D; this.chatManager.getTenant();
      //const loggedUser &#x3D; this.chatManager.getLoggedUser();
      let msg &#x3D; item.val();
      if (msg.sender !&#x3D; this.loggedUser.uid &amp;&amp; msg.status &lt; MSG_STATUS_RECEIVED){
        const urlNodeMessagesUpdate  &#x3D; &#x27;/apps/&#x27;+this.tenant+&#x27;/users/&#x27;+this.loggedUser.uid+&#x27;/messages/&#x27;+conversationWith+&quot;/&quot;+item.key;
        console.log(&quot;AGGIORNO STATO MESSAGGIO&quot;, urlNodeMessagesUpdate);
        firebase.database().ref(urlNodeMessagesUpdate).update({ status: MSG_STATUS_RECEIVED });
      }
    }
  }
  /**
   * controllo se il messaggio è stato inviato da loggerUser
   * richiamato dalla pagina elenco messaggi della conversazione
   * @param message 
   */
  isSender(message, currentUser) {
    //const currentUser &#x3D; this.loggedUser;//this.chatManager.getLoggedUser();
    //console.log(&quot;isSender::::: &quot;, message.sender, currentUser.uid);
    if (currentUser){
      if (message.sender &#x3D;&#x3D; currentUser.uid) {
        return true;
      } else {
        return false;
      }
    } else {
      return false;
    }
  }

  /**
   * bonifico url in testo messaggio
   * recupero time attuale
   * recupero lingua app
   * recupero sender_fullname e recipient_fullname
   * aggiungo messaggio alla reference
   * @param msg 
   * @param conversationWith 
   * @param conversationWithDetailFullname 
   */
  sendMessage(msg, type, metadata, conversationWith, conversationWithDetailFullname, channel_type) {
    const that &#x3D; this;
    (!channel_type || channel_type &#x3D;&#x3D; &#x27;undefined&#x27;)?channel_type&#x3D;&#x27;direct&#x27;:channel_type;
    console.log(&#x27;messages: &#x27;,  this.messages);
    console.log(&quot;SEND MESSAGE: &quot;, msg, channel_type);
    const now: Date &#x3D; new Date();
    // const timestamp &#x3D; now.valueOf();
    
    const timestamp &#x3D;  firebase.database.ServerValue.TIMESTAMP;
    console.log(&#x27;timestamp: &#x27;,timestamp);
    console.log(&#x27;timestamp: &#x27;,firebase.database[&#x27;ServerValue&#x27;][&#x27;TIMESTAMP&#x27;]);
    
    const language &#x3D; document.documentElement.lang;
    const sender_fullname &#x3D; this.loggedUser.fullname;
    const recipient_fullname &#x3D; conversationWithDetailFullname;
    const dateSendingMessage &#x3D; setHeaderDate(this.translate, timestamp);
    let firebaseMessagesCustomUid &#x3D; firebase.database().ref(this.urlNodeFirebase);
    const message &#x3D; new MessageModel(
      &#x27;&#x27;,
      language,
      conversationWith,
      recipient_fullname,
      this.loggedUser.uid,
      sender_fullname,
      &#x27;&#x27;,
      metadata,
      msg,
      timestamp,
      dateSendingMessage,
      type,
      this.attributes,
      channel_type
    ); 

    console.log(&#x27;messaggio **************&#x27;,message);
    //firebaseMessages.push(message);
    const messageRef &#x3D; firebaseMessagesCustomUid.push();
    const key &#x3D; messageRef.key;
    message.uid &#x3D; key;
    console.log(&#x27;messageRef: &#x27;, messageRef, key);
    messageRef.set(message, function( error ){
      // Callback comes here
      if (error) {
        // cambio lo stato in rosso: invio nn riuscito!!!
        message.status &#x3D; &#x27;-100&#x27;;
        console.log(&#x27;ERRORE&#x27;, error);
      } else {
        //that.checkWritingMessages();
        message.status &#x3D; &#x27;150&#x27;;
        console.log(&#x27;OK MSG INVIATO CON SUCCESSO AL SERVER&#x27;, message);
      }
      console.log(&#x27;****** changed *****&#x27;, that.messages);
    });

  }


  updateMetadataMessage(uid, metadata){
    metadata.status &#x3D; true;
    const message &#x3D; {
      metadata: metadata
    };
    let firebaseMessages &#x3D; firebase.database().ref(this.urlNodeFirebase+uid);
    firebaseMessages.set(message);
  }


  // // se è una immagine e la ha inviata l&#x27;utente corrente
  // if (type &#x3D;&#x3D; TYPE_MSG_IMAGE) {
  //   const index &#x3D; this.messages.findIndex(i &#x3D;&gt; i.uid &#x3D;&#x3D;&#x3D; metadata.uid);
  //   console.log(&quot;trovato mesg&quot;, this.messages[index].uid, metadata.uid);
  //   if(index&gt;-1){
  //     this.messages.splice(index, 1);
  //   }
  // } 

  /**
   * dispose reference della conversazione
   */
  dispose() {
    this.messagesRef.off();
  }


  unsubscribe(key){
    console.log(&quot;unsubscribe: &quot;, key);
    this.listSubsriptions.forEach(sub &#x3D;&gt; {
      console.log(&quot;unsubscribe: &quot;, sub.uid, key);
      if(sub.uid &#x3D;&#x3D;&#x3D; key){
        console.log(&quot;unsubscribe: &quot;, sub.uid, key);
        sub.unsubscribe(key, null);
        return;
      }
      
    });
    
  }



  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; begin:: subscribe MembersInfo &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;//
  /** */

  // initMembersInfo(uidGroup, tenant) {
  //   console.log(&quot;initMembersInfo: &quot;,uidGroup, tenant);
  //   this.listMembersInfo &#x3D; [];
  //   const that &#x3D; this;
  //   //const tenant &#x3D; this.chatManager.getTenant();
  //   const urlNodeContacts &#x3D; &#x27;/apps/&#x27;+tenant+&#x27;/groups/&#x27;+uidGroup+&#x27;/membersinfo/&#x27;;
  //   console.log(&quot;initMembersInfo: &quot;,urlNodeContacts);
  //   const ref &#x3D; firebase.database().ref(urlNodeContacts);
  //   ref.on(&quot;child_changed&quot;, function(childSnapshot) {
  //     that.onChangedMembersInfo(childSnapshot);
  //   });
  //   ref.on(&quot;child_removed&quot;, function(childSnapshot) {
  //     that.onRemovedMembersInfo(childSnapshot);
  //   });
  //   ref.on(&quot;child_added&quot;, function(childSnapshot) {
  //     that.onAddedMembersInfo(childSnapshot);
  //   })
  // } 

  // onAddedMembersInfo(snapshot){
  //   const memberInfo &#x3D; snapshot.val();
  //   this.listMembersInfo.splice(0, 0, memberInfo);
  //   console.log(&quot;onAddedMembersInfo: &quot;,this.listMembersInfo);
  // }

  // onRemovedMembersInfo(snapshot){
  //   const index &#x3D; searchIndexInArrayForUid(this.listMembersInfo, snapshot.key);
  //   if (index &gt; -1) {
  //       this.listMembersInfo.splice(index, 1);
  //   }
  //   console.log(&quot;onRemovedMembersInfo: &quot;,this.listMembersInfo);
  // }

  // onChangedMembersInfo(snapshot){
  //   const memberInfo &#x3D; snapshot.val();
  //   const index &#x3D; searchIndexInArrayForUid(this.listMembersInfo, snapshot.key);
  //   if (index &gt; -1) {
  //     this.listMembersInfo.splice(index, 1, memberInfo);
  //   }
  //   console.log(&quot;onChangedMembersInfo: &quot;,this.listMembersInfo);
  // }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; end:: subscribe MembersInfo &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;//

  

}</code></pre>
    </div>

</div>







                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'ChatConversationHandler.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
